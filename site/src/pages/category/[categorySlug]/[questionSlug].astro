---
import Layout from '../../../layouts/Layout.astro';
import { categories, folderMap } from '../../../data/categories';
import { marked } from 'marked';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  const paths: { params: { categorySlug: string; questionSlug: string }; props: any }[] = [];
  for (const cat of categories) {
    for (const q of cat.questions) {
      paths.push({
        params: { categorySlug: cat.slug, questionSlug: q.slug },
        props: { cat, q },
      });
    }
  }
  return paths;
}

const { cat, q } = Astro.props;
const base = import.meta.env.BASE_URL.replace(/\/?$/, '/');

// Read the markdown file from the parent repo
const folder = folderMap[cat.id];
const mdPath = path.resolve(process.cwd(), '..', folder, `${q.slug}.md`);
let rawMd = '';
try {
  rawMd = fs.readFileSync(mdPath, 'utf-8');
} catch {
  rawMd = `# ${q.title}\n\n_Content not found._`;
}

// Split into sections for structured rendering
function parseSections(md: string) {
  const sections: { heading: string; level: number; content: string }[] = [];
  const lines = md.split('\n');
  let currentHeading = '';
  let currentLevel = 0;
  let currentContent: string[] = [];

  for (const line of lines) {
    const h1 = line.match(/^# (.+)/);
    const h2 = line.match(/^## (.+)/);
    const h3 = line.match(/^### (.+)/);
    if (h1) {
      if (currentHeading) sections.push({ heading: currentHeading, level: currentLevel, content: currentContent.join('\n').trim() });
      currentHeading = h1[1]; currentLevel = 1; currentContent = [];
    } else if (h2) {
      if (currentHeading) sections.push({ heading: currentHeading, level: currentLevel, content: currentContent.join('\n').trim() });
      currentHeading = h2[1]; currentLevel = 2; currentContent = [];
    } else if (h3) {
      if (currentHeading) sections.push({ heading: currentHeading, level: currentLevel, content: currentContent.join('\n').trim() });
      currentHeading = h3[1]; currentLevel = 3; currentContent = [];
    } else {
      currentContent.push(line);
    }
  }
  if (currentHeading) sections.push({ heading: currentHeading, level: currentLevel, content: currentContent.join('\n').trim() });
  return sections;
}

const sections = parseSections(rawMd);
const title = sections.find(s => s.level === 1)?.heading ?? q.title;
const whyAsked = sections.find(s => s.heading === 'Why This Is Asked');
const keyPoints = sections.find(s => s.heading === 'Key Points to Cover');
const tips = sections.find(s => s.heading === 'Tips');
const exampleResponse = sections.find(s => s.heading === 'Example Response');
const companiesSection = sections.find(s => s.heading === 'Companies Known to Ask This');
const starSections = sections.filter(s => s.level === 3 && ['Situation', 'Task', 'Action', 'Result'].includes(s.heading));

const starColors: Record<string, string> = {
  Situation: 'from-violet-500 to-purple-600',
  Task: 'from-blue-500 to-cyan-600',
  Action: 'from-emerald-500 to-teal-600',
  Result: 'from-orange-500 to-amber-600',
};
const starIcons: Record<string, string> = {
  Situation: 'S',
  Task: 'T',
  Action: 'A',
  Result: 'R',
};

// Find adjacent questions for prev/next nav
const qIndex = cat.questions.findIndex(x => x.slug === q.slug);
const prevQ = qIndex > 0 ? cat.questions[qIndex - 1] : null;
const nextQ = qIndex < cat.questions.length - 1 ? cat.questions[qIndex + 1] : null;
---

<Layout title={title} description={whyAsked?.content ?? title}>
  <div class="max-w-3xl mx-auto px-4 sm:px-6 py-12">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-slate-500 mb-10 flex-wrap">
      <a href={base} class="hover:text-white transition-colors">Home</a>
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <a href={`${base}category/${cat.slug}/`} class="hover:text-white transition-colors">{cat.title}</a>
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <span class="text-slate-400">Question {qIndex + 1}</span>
    </nav>

    <!-- Question header -->
    <div class="mb-10">
      <div class="flex items-center gap-3 mb-4">
        <div class={`w-10 h-10 rounded-xl bg-gradient-to-br ${cat.color} flex items-center justify-center text-sm font-bold text-white`}>
          {cat.emoji}
        </div>
        <span class="text-sm text-slate-500">{cat.title} ¬∑ Q{qIndex + 1} of {cat.questions.length}</span>
      </div>
      <h1 class="text-3xl font-extrabold text-white leading-tight">{title}</h1>
    </div>

    <!-- Why This Is Asked -->
    {whyAsked && (
      <div class="glass rounded-2xl p-6 mb-6 border-l-4 border-violet-500">
        <h2 class="text-sm font-semibold text-violet-400 uppercase tracking-wider mb-3">Why This Is Asked</h2>
        <p class="text-slate-300 leading-relaxed">{whyAsked.content}</p>
      </div>
    )}

    <!-- Key Points -->
    {keyPoints && (
      <div class="glass rounded-2xl p-6 mb-6">
        <h2 class="text-sm font-semibold text-blue-400 uppercase tracking-wider mb-4">Key Points to Cover</h2>
        <div class="prose-dark" set:html={marked(keyPoints.content)} />
      </div>
    )}

    <!-- STAR Method -->
    {starSections.length > 0 && (
      <div class="mb-6">
        <h2 class="text-sm font-semibold text-emerald-400 uppercase tracking-wider mb-4">STAR Method Answer Template</h2>
        <div class="grid sm:grid-cols-2 gap-4">
          {starSections.map(s => (
            <div class="glass rounded-2xl p-5">
              <div class="flex items-center gap-3 mb-3">
                <div class={`w-8 h-8 rounded-lg bg-gradient-to-br ${starColors[s.heading]} flex items-center justify-center font-bold text-white text-sm`}>
                  {starIcons[s.heading]}
                </div>
                <span class="font-semibold text-white">{s.heading}</span>
              </div>
              <p class="text-slate-400 text-sm leading-relaxed italic">{s.content.replace(/_/g, '').replace(/\[|\]/g, '')}</p>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Tips -->
    {tips && (
      <div class="glass rounded-2xl p-6 mb-6 border-l-4 border-amber-500">
        <h2 class="text-sm font-semibold text-amber-400 uppercase tracking-wider mb-3">üí° Tips</h2>
        <div class="prose-dark" set:html={marked(tips.content)} />
      </div>
    )}

    <!-- Example Response -->
    {exampleResponse && (
      <div class="glass rounded-2xl p-6 mb-6 border-l-4 border-emerald-500">
        <div class="flex items-center gap-2 mb-4">
          <h2 class="text-sm font-semibold text-emerald-400 uppercase tracking-wider">‚úçÔ∏è Example Response</h2>
          <span class="text-xs text-slate-600 bg-white/5 rounded-full px-2 py-0.5">STAR format</span>
        </div>
        <div class="prose-dark space-y-3" set:html={marked(exampleResponse.content)} />
      </div>
    )}

    <!-- Companies Known to Ask This -->
    {companiesSection && (
      <div class="glass rounded-2xl p-6 mb-10 border-l-4 border-blue-500">
        <h2 class="text-sm font-semibold text-blue-400 uppercase tracking-wider mb-4">üè¢ Companies Known to Ask This</h2>
        <div class="prose-dark" set:html={marked(companiesSection.content)} />
      </div>
    )}

    <!-- Prev / Next navigation -->
    <div class="grid grid-cols-2 gap-4 pt-8 border-t border-white/8">
      {prevQ ? (
        <a href={`${base}category/${cat.slug}/${prevQ.slug}/`} class="group glass rounded-xl p-4 hover:bg-white/8 transition-all">
          <div class="text-xs text-slate-500 mb-2 flex items-center gap-1">
            <svg class="w-3 h-3 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Previous
          </div>
          <p class="text-sm text-slate-300 group-hover:text-white transition-colors line-clamp-2">{prevQ.title}</p>
        </a>
      ) : <div />}

      {nextQ ? (
        <a href={`${base}category/${cat.slug}/${nextQ.slug}/`} class="group glass rounded-xl p-4 hover:bg-white/8 transition-all text-right">
          <div class="text-xs text-slate-500 mb-2 flex items-center justify-end gap-1">
            Next
            <svg class="w-3 h-3 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
          <p class="text-sm text-slate-300 group-hover:text-white transition-colors line-clamp-2">{nextQ.title}</p>
        </a>
      ) : <div />}
    </div>

    <!-- Back to category -->
    <div class="mt-6">
      <a href={`${base}category/${cat.slug}/`} class="inline-flex items-center gap-2 text-slate-500 hover:text-white transition-colors text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to {cat.title}
      </a>
    </div>
  </div>
</Layout>
